---
- name: Install and Configure MySQL Server
  hosts: mysql_instance
  become: yes

  vars:
    mysql_root_password: "your_secure_password"
    nat_user_password: "password"

  tasks:
    - name: Ensure pip3 is installed
      apt:
        name: python3-pip
        state: present

    - name: Install PyMySQL for MySQL interaction
      pip:
        name: PyMySQL
        state: present

    - name: Update package list
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Install MySQL server
      apt:
        name: mysql-server
        state: present

    - name: Enable MySQL service
      systemd:
        name: mysql
        enabled: yes

    - name: Start MySQL service
      systemd:
        name: mysql
        state: started

    - name: Change MySQL root authentication method to use password
      shell: |
        mysql -u root <<EOF
        ALTER USER 'root'@'localhost' IDENTIFIED WITH mysql_native_password BY '{{ mysql_root_password }}';
        FLUSH PRIVILEGES;
        EOF
      become: yes
      ignore_errors: yes  # Allow task to proceed if already applied.

    - name: Create MySQL credentials file for root
      copy:
        dest: /root/.my.cnf
        content: |
          [client]
          user = root
          password = "{{ mysql_root_password }}"
      mode: '0600'

    - name: Create 'nat_user' user for specific IP range
      mysql_user:
        name: nat_user
        password: "{{ nat_user_password }}"
        host: '10.0.2.%'
        priv: '*.*:ALL'
        state: present
        login_user: root
        login_password: "{{ mysql_root_password }}"

    - name: Update MySQL configuration to allow connections from all IPs
      lineinfile:
        path: /etc/mysql/mysql.conf.d/mysqld.cnf
        regexp: '^#?bind-address'
        line: 'bind-address = 0.0.0.0'
        state: present

    - name: Restart MySQL service
      systemd:
        name: mysql
        state: restarted
